---
title: "Cartographie"
subtitle: "avec Python üêç"
author: "Pascal Burkhard"
institute: "LDDR 2021-2022"
output:
  xaringan::moon_reader:
    css: [default, metropolis, metropolis-fonts, personal.css]
    lib_dir: libs
    self_contained: false
    nature:
      ratio: 16:9
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
---

```{r setup, include=FALSE}
library(xaringanthemer)
library(flair)
options(htmltools.dir.version = FALSE)
style_extra_css(
  css = list(
    ".remark-slide-content" = list("padding-left" = "80px", "padding-right" = "80px"),
    ".remark-code" = list("background" = "#dedede !important", "white-space" = "pre-wrap !important"),
    ".remark-code-line" = list("color" = "#00496f"),
    ".remark-inline-code" = list("background" = "#dedede !important"),
    ".pull-left" = list("float" = "left", "width" = "47%"),
    ".pull-right" = list("float" = "right", "width" = "47%"),
    ".pull-left-large" = list("float" = "left", "width" = "63%"),
    ".pull-right-large" = list("float" = "right", "width" = "63%"),
    ".pull-left-small" = list("float" = "left", "width" = "30%"),
    ".pull-right-small" = list("float" = "right", "width" = "30%"),
    ".bordered" = list("display" = "inline-block", "border" = "1px solid black"),
    ".flair-pink code" = list("background-color" = "#ad8cae !important"),
    ".flair-blue code" = list("background-color" = "#4f93b8 !important"),
    ".flair-green code" = list("background-color" = "#2e9093 !important"),
    ".flair-orange code" = list("background-color" = "#ee950b !important"),
    ".flair-red code" = list("background-color" = "#dd4123 !important"),
    ".boldcenter" = list(
      "display" = "block",
      "font-size" = "28px !important",
      "font-weight" = "bold",
      "margin-top" = "80px",
      "text-align" = "center"
    ),
    ".boldcenter a" = list(
      "font-size" = "28px !important"
    )
  ),
  outfile = "personal.css",
  append = FALSE,
  heading = "Extra CSS"
)
```

# Cartographie

## Introduction

.pull-left-large[La cartographie consiste √† repr√©senter un espace (g√©n√©ralement r√©el) sous une forme graphique simplifi√©e.

Historiquement les plus vieilles cartes dont on garde une trace sont des *p√©troglyphes* comme ceux de Bedolina en Italie (voir ci-contre).

Au cours de la pr√©histoire, les civilsations greco-romaines font de la cartographie une discipline √† part enti√®re. Des savants tels qu'Eratosth√®ne et Ptol√©m√©e perfectionnent les techniques et mettent en place des concepts tels que les *syst√®mes de coordon√©es* ou les *projections*.]

.pull-right-small[
```{r, echo=FALSE}
knitr::include_graphics("img/bedolina.jpg")
```
]

---

# Cartographie

## Introduction

.pull-left[Au fil des si√®cles, les cartes r√©alis√©es √† l'√©poque de Ptol√©m√©e sont reprises et parfois augment√©es.

Le d√©veloppement de la cartographie est souvent √©troitement li√© avec les volont√©es de conqu√™te et d'exploration. Les progr√®s, notament dans le domaine de la navigation permettent √©galement d'√©tendre les fronti√®res du monde connue et d'am√©liorer les cartes existante.

Au 16e Si√®cle, des cartographes comme *Gerardus Mercator* et *Abraham Ortelius* donne un nouvel √©lan √† la discipline. L'invention d'une projection *conforme* par *Mercator* am√©liore consid√©rablement la navigation. En effet, un cape pr√©cis √©quivaut √† une ligne droite sur ce type de cartes.]

.pull-right[
```{r, echo=FALSE}
knitr::include_graphics("img/mercator.png")
```
]

---

# Cartographie informatique

## Les *syst√®mes d'information g√©ographique*

.pull-left-large[Avec l'apparition des outils num√©riques, la cartographie vit une nouvelle r√©volution: l'apparition des *syst√®mes d'information g√©ographique* ou *SIG* (*GIS* en anglais). La cartographie devient num√©rique et offre des possibilit√©s de recueil, de traitement et d'analyse qui √©tait jusqu'√† pr√©sent inimaginable.

Diff√©rentes couches de donn√©es peuvent √™tre superpos√©es, analys√©es, voir combin√©es pour obtenir des informations ou des cartes de synth√®se. Ces couches peuvent contenir des donn√©es de nature tr√®s vari√©e (donn√©es satellites, hydrographie, topographie, routes, constructions, zones d'amm√©nagement, informations statistiques, ‚Ä¶).]

.pull-right-small[
```{r, echo=FALSE}
knitr::include_graphics("img/gis_layers.jpg")
```
]

---

# Cartographie informatique

## Types de donn√©es

.pull-left-small[
Les donn√©es num√©rique de cartographie se divise en deux types :

- les donn√©es *vectorielles*
- les donn√©es *raster*

Les donn√©es vecteurs peuvent √™tre subdivis√©e en trois types :

- point
- ligne
- polygone
]

.pull-right-large[
```{r, echo=FALSE}
knitr::include_graphics("img/raster_vector.png")
```
]

---

# Cartographie informatique

## Exercices

Lien vers le portail pour les exercices :

.boldcenter[
[https://geoviews.link/PyCartoProj](https://geoviews.link/PyCartoProj)
]

---

# Cartographie informatique

## Lire des donn√©es raster

Nous aurons besoin des modules suivants :

```{python}
import matplotlib.pyplot as plt # Pour afficher les donn√©es raster
from matplotlib import cm # Pour la palette de couleur
from osgeo import gdal # Pour lire les donn√©es raster
```

Pour lire des donn√©es raster on aura recours √† la fonction `Open` de `gdal` :

```{python}
DEM = gdal.Open("geodata/Neuchatel.tif")
DEM_Array = DEM.GetRasterBand(1).ReadAsArray()
DEM_Array.ndim
```

DEM_Array est une matrice avec 2 dimensions: un *rectangle* de donn√©es avec les dimensions suivantes:

```{python}
DEM_Array.shape
```

---

# Cartographie informatique

## Lire des donn√©es raster ‚Äì exercice

Explorez la matrice `DEM_Array`. Vous pouvez acc√©der √† des morceaux de la matrice de la fa√ßon suivant:

```{python, results=FALSE}
DEM_Array[50] # Donne toutes les donn√©es le long de la 51√®me ligne
DEM_Array[120,120] # Donne la donn√©es de la 121√®me ligne et de la 121√®me colonne
DEM_Array[120,120:130] # Donne les donn√©es de la 121√®me ligne, allant de la 121√®me √† la 130√®me colonne
```

En sachant qu'il s'agit de donn√©es raster du canton de Neuch√¢tel. Quelle donn√©es pourrait-on avoir *encod√©* dans cette matrice ?

--

```{python}
DEM_Array[50,120:130]
```

Comme nous le montre ce petit *extrait* de la matrice, il s'agit tr√®s certainement de l'**altitude**.

---

# Cartographie informatique

## Afficher des donn√©es raster ‚Äì exercice

.pull-left[
En quelque lignes on peut se rendre compte de ce que donne cette matrice.

```{python neuch-elev, results=FALSE, fig.show='hide'}
plt.imshow(DEM_Array, cmap=cm.gist_earth) # On affiche la matrice sous forme d'image, cmap = palette de couleur √† utiliser
plt.axis('off') # On d√©sactive les coordon√©es autour de la carte

cbar = plt.colorbar(shrink=0.5) # On r√©cup√®re la barre de couleur (en la r√©duisant √† 50% de sa taille originale)
cbar.set_label('m√®tres') # et on rajoute le Label `m√®tres` 

plt.show() # Et on affiche la figure 
```

Essayez !
]

--

.pull-right[
```{r, echo=FALSE}
knitr::include_graphics(
  knitr::fig_chunk("neuch-elev", "png")
)
```
]

---

# Cartographie informatique

## Lire des donn√©es vecteur

Nous aurons besoin des modules suivants :

```{python}
import pandas as pd # pandas permet de manipuler des tableaux de donn√©es
import geopandas as gpd # geopandas `√©tend` panda pour permettre des colonnes `vecteur`
import matplotlib.pyplot as plt # Pour afficher des donn√©es
from matplotlib.colors import TwoSlopeNorm # Pour la palette de couleur
```

Pour lire des donn√©es vecteur on aura recours √† la fonction `read_file` de `geopandas` :

```{python}
cantons = gpd.read_file('geodata/Cantons.shp')
```

---

# Cartographie informatique

## Lire des donn√©es vecteur ‚Äì exercice

Explorez la tableau de donn√©es `cantons`. Vous pouvez afficher les colonnes de la mani√®re suivantes :

```{python, results=FALSE}
cantons.columns # Affiche le nom de toutes les colonnes du tableau `cantons`
cantons['KTNAME'] # Affiche le contenu de la colonne `KTNAME`
```

Quelle colonne contient les informations g√©ographiques ? Comment sont-elles repr√©sent√©es ?

--

```{python}
cantons['geometry'].head(5)
```

---

# Cartographie informatique

## Lire des donn√©es statistiques ‚Äì exercice

Pandas permet de lire des donn√©es statistiques (sous forme de fichier *csv*, *excel* ou autre tableau de donn√©es) :

```{python}
pop = pd.read_csv('statdata/swiss_pop_2021.csv')
nat = pd.read_csv('statdata/swiss_nat_2021.csv')
```


En utilisant les m√™mes fonctions que pour le tableau `cantons`, explorer les tableaux `pop` et `nat`. Que contiennent-ils¬†?

--

Les chiffres de la **population** et des **taux de natalit√©** par cantons suisses.

---

# Cartographie informatique

## Combiner des tableaux de donn√©es

*Pandas/GeoPandas* permet de facilement combiner des tableaux de donn√©es lorsqu'on poss√®de une colonne qui identifie de la m√™me mani√®re les donn√©es de deux tableaux diff√©rents.

Le code ci-dessous combine le tableau `cantons` (avec sa colonne *identifiant* `KTNR`) avec le tableau `nat` et sa colonne `ID` :

```{python}
cantons_nat = cantons.set_index('KTNR').join(nat.set_index('ID'))
cantons_nat.head(3)
```

La fonction `set_index()` indique la colonne √† utiliser comme *cl√©* d'identification.

---

# Cartographie informatique

## Combiner des tableaux de donn√©es ‚Äì exercice

Trouvez un moyen de combiner le tableau `cantons` avec les donn√©es du tableau `pop` **et** les donn√©es du tableau `nat`.

--

Indice : la colonne `Canton` dans les deux tableaux `pop` et `nat` pose probl√®me lorsqu'on essaye de joindre le deuxi√®me tableau. La fonction `drop(columns = 'NomDeColonne')` permet de retirer une colonne d'un tableau.

--

```{python}
cantons_pop_nat = cantons.set_index('KTNR').join(pop.set_index('ID')).join(nat.set_index('ID').drop(columns = 'Canton'))
cantons_pop_nat.columns
```

---

# Cartographie informatique

## Combiner des tableaux de donn√©es ‚Äì exercice

Il est relativement simple de manipuler des tableaux de donn√©es. Si on veut par exemple cr√©er une colonne `TxNat` qui contient le taux de natalit√© (en pour mille), on peut proc√©der de la sorte :

```{python}
cantons_pop_nat['TxNat'] = cantons_pop_nat['Naissances']/cantons_pop_nat['Population']*1000
cantons_pop_nat['TxNat'].head(3)
```

Cr√©ez les colonnes `TxNat` avec le *taux de natalit√©* (comme ci-dessus), ainsi qu'une colonne `RapFG` avec le rapport des sexes (nombre de naissances *gar√ßons* pour 100 naissances *filles*).

---

# Cartographie informatique

## Combiner des tableaux de donn√©es ‚Äì exercice

```{python}
cantons_pop_nat['RapFG'] = cantons_pop_nat['Gar√ßons']/cantons_pop_nat['Filles']*100
cantons_pop_nat['RapFG'].head(10)
```

---

# Cartographie informatique

## Afficher des donn√©es vecteur

.pull-left[
On peut tr√®s facilement afficher la carte d'un tableau de donn√©es g√©ographiques.

```{python map-swiss-no-data, fig.show='hide'}
cantons_pop_nat.plot()
```
]

.pull-right[
```{r, echo=FALSE}
knitr::include_graphics(
  knitr::fig_chunk("map-swiss-no-data", "png")
)
```
]

---

# Cartographie informatique

## Afficher des donn√©es vecteur

.pull-left[
En sp√©cifiant un argument `column='TxNat'` par exemple, on peut afficher les donn√©es d'une colonne sur la carte.

```{python map-swiss-cbr, fig.show='hide'}
cantons_pop_nat.plot(column='TxNat', legend=True)
```
]

.pull-right[
```{r, echo=FALSE}
knitr::include_graphics(
  knitr::fig_chunk("map-swiss-cbr", "png")
)
```
]

---

# Cartographie informatique

## Afficher des donn√©es vecteur ‚Äì exercice

Faites une carte avec le rapport de naissances filles/gar√ßons. Quel probl√®me pouvez-vous constater ?

--

.pull-left[
```{python map-swiss-sxrt, fig.show='hide'}
cantons_pop_nat.plot(column='RapFG', legend=True)
```
]

.pull-right[
```{r, echo=FALSE}
knitr::include_graphics(
  knitr::fig_chunk("map-swiss-sxrt", "png")
)
```
]

---

# Cartographie informatique

## Afficher des donn√©es vecteur ‚Äì exercice

--

.pull-left[
```{python map-swiss-sxrt-2, fig.show='hide', results=FALSE}
vmin, vmax, vcenter = cantons_pop_nat['RapFG'].min(), cantons_pop_nat['RapFG'].max(), 100
norm = TwoSlopeNorm(vmin=vmin, vcenter=vcenter, vmax=vmax)

cmap = 'RdBu'
cbar = plt.cm.ScalarMappable(norm=norm, cmap=cmap)

cantons_pop_nat.plot(column='RapFG', cmap=cmap, legend=False)

plt.colorbar(cbar, orientation = 'horizontal')
plt.axis('off')
plt.show()
```
]

.pull-right[
```{r, echo=FALSE}
knitr::include_graphics(
  knitr::fig_chunk("map-swiss-sxrt-2", "png")
)
```
]

---

# Cartographie informatique

## Projet ‚Äì travaux de groupes

Explorez les donn√©es qui se trouvent dans le dossier *statdata*. √Ä partir de ces donn√©es :

- r√©alisez une carte ‚Äì √©ventuellement en combinant plusieurs indicateurs ;
- analysez la carte que vous obtenez ;
- pr√©parez une br√®ve pr√©sentation de votre carte et de ce qu'elle montre (~5 minutes).
